name: API Automation Tests

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Setup Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3️⃣ Run tests
      - name: Run tests
        run: mvn clean test

      # 4️⃣ Generate Execution Summary
      - name: Generate Execution Summary
        run: |
          echo "TOTAL=$(grep -o 'Tests run: [0-9]*' target/surefire-reports/*.txt | awk '{sum+=$3} END {print sum}')" >> $GITHUB_ENV
          echo "FAILURES=$(grep -o 'Failures: [0-9]*' target/surefire-reports/*.txt | awk '{sum+=$2} END {print sum}')" >> $GITHUB_ENV
          echo "SKIPPED=$(grep -o 'Skipped: [0-9]*' target/surefire-reports/*.txt | awk '{sum+=$2} END {print sum}')" >> $GITHUB_ENV

      # 5️⃣ Upload Cucumber Report
      - name: Upload Cucumber Report
        uses: actions/upload-artifact@v4
        with:
          name: Cucumber-Report
          path: target/cucumber-report.html

      # 6️⃣ Upload ChainTest Report
      - name: Upload ChainTest Report
        uses: actions/upload-artifact@v4
        with:
          name: ChainTest-Report
          path: target/chaintest/resources/Email.html

      # 7️⃣ Send Test Execution Email via SendGrid
      - name: Send Test Execution Email
        if: always() && secrets.SENDGRID_API_KEY != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          secure: false
          username: apikey                     # literal, correct for SendGrid
          password: ${{ secrets.SENDGRID_API_KEY }}
          from: ${{ secrets.SENDGRID_FROM }}  # Verified sender
          to: ${{ secrets.EMAIL_TO }}
          subject: "API Automation Test Report – Build #${{ github.run_number }} on ${{ github.ref_name }}"

          html_body: |
            <h3>API Automation Execution Summary</h3>
            <table border="1" cellpadding="6">
              <tr>
                <th>Total</th>
                <th>Failures</th>
                <th>Skipped</th>
              </tr>
              <tr>
                <td>${{ env.TOTAL }}</td>
                <td>${{ env.FAILURES }}</td>
                <td>${{ env.SKIPPED }}</td>
              </tr>
            </table>

            <br/>
            <b>Reports:</b>
            <ul>
              <li>Cucumber HTML – Attached</li>
              <li>ChainTest Email HTML – Attached</li>
              <li>
                Artifacts Download – 
                <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">
                  Click here
                </a>
              </li>
            </ul>

            <br/>
            Regards,<br/>
            CI Automation Pipeline

          attachments: |
            target/cucumber-report.html
            target/chaintest/resources/Email.html
