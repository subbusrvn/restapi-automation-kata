name: API Automation Tests

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Setup Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3️⃣ Run tests (do not fail job here)
      - name: Run tests
        run: mvn clean test || true

      # 4️⃣ Generate Execution Summary (safe)
      - name: Generate Execution Summary
        run: |
          TOTAL=$(grep -h "Tests run:" target/surefire-reports/*.txt 2>/dev/null | awk '{sum+=$3} END {print sum+0}')
          FAILURES=$(grep -h "Failures:" target/surefire-reports/*.txt 2>/dev/null | awk '{sum+=$2} END {print sum+0}')
          SKIPPED=$(grep -h "Skipped:" target/surefire-reports/*.txt 2>/dev/null | awk '{sum+=$2} END {print sum+0}')
          PASSED=$((TOTAL - FAILURES - SKIPPED))

          echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          echo "FAILURES=$FAILURES" >> $GITHUB_ENV
          echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
          echo "PASSED=$PASSED" >> $GITHUB_ENV

      # 5️⃣ Generate Email HTML (env vars expand correctly)
      - name: Generate Email Body
        run: |
          cat <<EOF > email.html
          <h2>API Automation Execution Summary</h2>

          <table border="1" cellpadding="6" cellspacing="0">
            <tr>
              <th>Total</th>
              <th style="color:green;">Passed</th>
              <th style="color:red;">Failed</th>
              <th style="color:orange;">Skipped</th>
            </tr>
            <tr>
              <td>${TOTAL}</td>
              <td>${PASSED}</td>
              <td>${FAILURES}</td>
              <td>${SKIPPED}</td>
            </tr>
          </table>

          <br/>

          <b>Branch:</b> ${{ github.ref_name }}<br/>
          <b>Build Number:</b> #${{ github.run_number }}<br/>
          <b>Execution Status:</b> ${{ job.status }}<br/>

          <br/>
          <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">
            View Full Execution Details
          </a>

          <br/><br/>
          Regards,<br/>
          CI Automation Pipeline
          EOF

      # 6️⃣ Upload Cucumber Report
      - name: Upload Cucumber Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Cucumber-Report
          path: target/cucumber-report.html
          if-no-files-found: warn

      # 7️⃣ Upload ChainTest Report
      - name: Upload ChainTest Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ChainTest-Report
          path: target/chaintest/resources/Email.html
          if-no-files-found: warn

      # 8️⃣ Send Test Execution Email via SendGrid
      - name: Send Test Execution Email
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          secure: true
          username: apikey
          password: ${{ secrets.SENDGRID_API_KEY }}
          from: ${{ secrets.SENDGRID_FROM }}
          to: ${{ secrets.EMAIL_TO }}
          subject: "API Automation Test Report – Build #${{ github.run_number }}"
          html_body: file://email.html
          attachments: |
            target/cucumber-report.html
            target/chaintest/resources/Email.html
